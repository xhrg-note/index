## 高可用(Highly Available)


> 为什么需要做高可用设计

一般情况下，我们最简单的一个服务，比如redis启动，一个单节点就行了。但是这样会有一个问题，那就是假如这个节点挂了，系统将不会提供服务，这种情况是无法容忍的，于是乎，我们在设计基础组件的时候，需要考虑高可用设计。那么高可用设计有哪些点或者角度呢。


#### 集群

1. 节点的主从模式。rocketmq，mysql
2. 不通讯的集群模式。quartz
3. 一致性算法模式。zookeeper，etcd
4. 数据块的主从模式。redis-cluster，hazelcast，kafka
5. 所有节点全量数据。consul


#### hazelcast

hazelcast会把数据分成271个分区，当然这个数字可以配置。每次put一个kv，他会根据key做hash然后取模271定位到一个区间。那么这个区间003号在哪个实例中，就是元数据，他的元数据每个节点都存储。为了举例子说明容易，我们加着分区是12个,而不是默认的271个。
* 启动一个节点，那么这个节点包括的分区是，1到12所有的分区。
* 再启动一个节点，目前是2个节点。那么数据是节点A[1到6主数据]和[7到12备份数据]，节点B[1到6主数据]和[7到12备份数据]
* 在启动一个节点，目前是3个节点。那么数据可能是
  * 节点A[1到4主数据]和[5到8备份数据]
  * 节点B[5到8主数据]和[9到12备份数据]
  * 节点C[9到12主数据]和[1到4备份数据]
 * 假设目前是3个节点，然后某一个节点宕机了，那么数据会恢复到以上步骤的2个节点的状态。这个时候，数据会自动迁移。

 如上如果是3个节点，那么所有的数据都有一个备份，实际上这个副本数量也可以修改个数。hazelcast的特点是，当你加入新节点，或者删除节点的时候，他会重新分配分区数据。这个时候，当集群数量很多的时候，一旦发生节点故障[包括网络断连、节点宕机、节点死机，响应很慢]，就会大规模的数据变化。