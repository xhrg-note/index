# rocketmq文件存储


## 一、文件内容是什么？？？


本章节不会讲述任何与rocketmq代码有关系的东西，也不会讲高性能文件读写相关原理。纯粹讲rocketmq生成的文件有哪些，存储哪些东西，预备知识如下：

* offset是什么？

我们写文件的时候，准确的说写的都是字节byte[-128_127]，比如我在文件中写了一个整型的数字1，那么一个int数字占用四个字节，那么文件里面实际上就是写了4个byte[-128_127]数字。offset指的是偏移，比如说我写了2个int数字3和800，那么800的起始位置的偏移就是5，第五个字节开始。

* 内容存储的小办法？

比如说假设我们公司的同事姓名有2个的，也有3个的，然后我要把他们的名字写在一个文本中然后读取。那么我可以这样做"张三#李小四#王二",用#号分割。当然我也可以这么做"2张三3李小四2王二"，第一步，我读取一个数字int是2，那么往后的2位就是一个人的姓名，读完2位后，我再读一个数字是3，那么表示往后的3位又是一个人的姓名。这里我的2，3是字符数的个数，实际在使用中用字节表示。比如说第一个数字是int，那么我固定读取4个字节，一看是8，我再读8个字节转换出来就是姓名。


先搭建rocketmq单机，然后发送消息后，默认生产的文件路径是 {user.home}/store下，测试会生产文件内容如下


<img src="base/mq/rocketmq/pic/rocketmq_file.jpg" width="400"/>

如上图所示：

#### commitlog

这个是真实存消息的数据，比如说你发送了一个消息过去，你的消息内容是一些使用数据，那么这个数据就存在这里的。

commitlog下一般会有多个文件，broker写数据的时候，从第一个文件开始写，当第一个文件达到1G的时候，就写第二个文件，然后第三个第四个。一般是20个数字.
比如"00000000000000000000"，"00000000001073741824" 2个文件，可以用第二个文件的数字按照字节计算下，正好是1G。比如说我有一个消息，这个消息的offset是00000000002073741824这样一个我随便假设的数字，那么我只要这个数字大于文件名，且小于下一个文件名，然后用这个数字减去文件名的数字，就是这个消息所在的这个文件的位置。

#### consumequeue

rocketmq有生产者会生产消息，然后他把这些消息，按照逻辑分位多份，上图所示是4份。比如说我发送消息的内容是1，2，3，4发了4个数字。然后我的消费者部署了4个节点，我需要的效果是，1，2，3，4这四个数字分别落到4个消费节点上，而不是全部到其中一个节点上。他是怎么实现这个功能的呢？现在消息生产者发送的消息落在了commitlog文件夹下，然后他有一个异步线程池，这个线程池会一个一个的遍历消息，遍历消息的时候，能看到这个消息的topic名称。比如说遍历第一个消息，发现topic名称是MyTopicName，然后就把这个消息的位置offset写到consumequeue文件夹下的同名目录MytopicName目录下的0号文件夹下的第一个文件中，假设第二个还是这个topic的消息，那么我就写到1号文件夹，然后2号，3号，结束后再有再1号文件夹。这样，他就把同一个topic的消息的位置，写在了consumequeue目录下的topic名称下的0，1，2，3文件夹下。这个时候，如果你启动了消费者，消费者个数可能是n个，我们假设2个消费者，那么我就让第一个消费者去读0和2号目录，第二个消费者去读1和3号目录，以此实现了数据分散消费。

当然在topic名称下的数字编号的下面的文件也是递增的，其逻辑也是写满了再写下一个文件。实际上这个topic名称下的数字名称的文件夹的数字，就是queueid

#### config

这个是用来存放一些配置信息和当前的一些状态信息的

###### consumerOffset.json

```
{
	"offsetTable":{
		"MyTopicName@MyConsumerGroup":{0:2079,1:2078,2:2105,3:2078}
	}
}
```

现在假设我们的系统中有10个消息，然后消费者只有一个，启动后消费了4个停机了，然后再启动需要从第五个开始读，这个第五个的记录记在哪里呢，就是这个consumerOffset.json中，对应topic名称，groupName，也就是消费者的名称，然后后面的{0:2079,1:2078,2:2105,3:2078}表示queueid和进度


#### index

这个是用来搜索消息的，你现在在控制台想查询以前发过的消息，怎么快速查找，就是依靠index文件夹